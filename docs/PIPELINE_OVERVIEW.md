# Pipeline Overview

## What this pipeline does
- Converts financial-report PDFs into Docling documents, then emits Markdown with page markers, cleaned headings, and KPI/table repairs, all orchestrated in [src/pdf_to_markdown_docling/conversion_utils.py#L231-L288](src/pdf_to_markdown_docling/conversion_utils.py#L231-L288).
- CLI parsing resolves inputs, outputs, image handling, OCR flags, and spacing options before invoking the converter in [src/pdf_to_markdown_docling/cli.py#L61-L284](src/pdf_to_markdown_docling/cli.py#L61-L284).
- Docling PDF backends (pypdfium2, docling-parse-v4) are selected directly or via auto-scoring of a sampled page in [src/pdf_to_markdown_docling/conversion_utils.py#L180-L236](src/pdf_to_markdown_docling/conversion_utils.py#L180-L236).
- Spacing/table repairs leverage Docling word cells or PyMuPDF glyphs plus OCR fallbacks in [src/pdf_to_markdown_docling/conversion_utils.py#L400-L512](src/pdf_to_markdown_docling/conversion_utils.py#L400-L512), [src/pdf_to_markdown_docling/spacing_fix.py#L221-L305](src/pdf_to_markdown_docling/spacing_fix.py#L221-L305), and [src/pdf_to_markdown_docling/pymupdf_spacing_fix.py#L365-L509](src/pdf_to_markdown_docling/pymupdf_spacing_fix.py#L365-L509).
- Post-processing normalizes whitespace, table headers, KPI captions, and Markdown noise in [src/pdf_to_markdown_docling/table_fixes.py#L415-L809](src/pdf_to_markdown_docling/table_fixes.py#L415-L809), [src/pdf_to_markdown_docling/picture_kpi_extract.py#L196-L279](src/pdf_to_markdown_docling/picture_kpi_extract.py#L196-L279), [src/pdf_to_markdown_docling/date_cleanup.py#L73-L189](src/pdf_to_markdown_docling/date_cleanup.py#L73-L189), [src/pdf_to_markdown_docling/whitespace_fix.py#L7-L46](src/pdf_to_markdown_docling/whitespace_fix.py#L7-L46), and [src/pdf_to_markdown_docling/export_utils.py#L31-L355](src/pdf_to_markdown_docling/export_utils.py#L31-L355).
- UNKNOWN: PyMuPDF4LLM engine not found (searched for "PyMuPDF4LLM" in src/**).

## Entry points
- CLI shim for direct execution: [main.py#L1-L22](main.py#L1-L22) delegates into the package CLI.
- Primary CLI (argparse): [src/pdf_to_markdown_docling/cli.py#L61-L284](src/pdf_to_markdown_docling/cli.py#L61-L284) builds flags, resolves env defaults, and runs conversion/audit/export.
- Audit-only script: [scripts/audit_pdf_vs_md.py#L1-L134](scripts/audit_pdf_vs_md.py#L1-L134) reruns conversion for audit metrics against an existing Markdown file.
- Quality-only script: [scripts/quality_report.py#L1-L32](scripts/quality_report.py#L1-L32) scores Markdown noise.

## Engine selection logic
- Backends available: pypdfium2 and docling-parse-v4 registered in [src/pdf_to_markdown_docling/conversion_utils.py#L53-L76](src/pdf_to_markdown_docling/conversion_utils.py#L53-L76).
- Selection is driven by `--pdf-backend` CLI flag (`auto` | `pypdfium2` | `docling-parse-v4`) parsed in [src/pdf_to_markdown_docling/cli.py#L109-L125](src/pdf_to_markdown_docling/cli.py#L109-L125) and forwarded to conversion in [src/pdf_to_markdown_docling/cli.py#L223-L243](src/pdf_to_markdown_docling/cli.py#L223-L243).
- Auto mode probes one page with each backend, scores Markdown quality, and picks the higher score via [_probe_backend](src/pdf_to_markdown_docling/conversion_utils.py#L180-L204) and [select_backend_auto](src/pdf_to_markdown_docling/conversion_utils.py#L205-L229). Manual modes bypass probing and instantiate the requested backend in [convert_pdf_to_doc](src/pdf_to_markdown_docling/conversion_utils.py#L290-L365).
- Data contract: both backends return Docling `ConversionResult`/`DoclingDocument` objects consumed uniformly downstream (see [convert_pdf_to_doc](src/pdf_to_markdown_docling/conversion_utils.py#L290-L512)), so post-processing does not branch by backend.

## Pipeline stages (execution order)
1) **CLI + env resolution** — Parse args, load `.env`/env vars (`FIN_REPORT_PDF`, KPI/OCR flags), resolve paths, and map image mode enums in [src/pdf_to_markdown_docling/cli.py#L19-L217](src/pdf_to_markdown_docling/cli.py#L19-L217). Inputs: CLI/env. Outputs: typed args, resolved paths. Flags: all CLI options. Failure: missing input raises `SystemExit` in [src/pdf_to_markdown_docling/cli.py#L181-L191](src/pdf_to_markdown_docling/cli.py#L181-L191). Perf: negligible.
2) **Docling pipeline setup** — Build export label set and Docling pipeline options (layout model, OCR options, device, table structure) in [build_export_labels](src/pdf_to_markdown_docling/conversion_utils.py#L169-L178) and [build_pdf_pipeline_options](src/pdf_to_markdown_docling/conversion_utils.py#L133-L168). Inputs: CLI flags. Outputs: pipeline configs. Flags: `--device`, `--ocr*`, spacing fix influences later. Perf: minimal.
3) **Backend selection** — Auto probe or direct backend binding in [select_backend_auto](src/pdf_to_markdown_docling/conversion_utils.py#L205-L229) and [_probe_backend](src/pdf_to_markdown_docling/conversion_utils.py#L180-L204). Inputs: pipeline options. Outputs: backend class name. Flags: `--pdf-backend`. Perf: extra single-page convert per backend in auto mode (I/O/CPU/GPU heavy for that page).
4) **Primary conversion run(s)** — Execute Docling conversion, optionally twice for OCR auto-retry, inside [convert_pdf_to_doc](src/pdf_to_markdown_docling/conversion_utils.py#L290-L378). Inputs: PDF path, pipeline options. Outputs: `ConversionResult`, backend name. Flags: `--ocr-mode`, `--ocr`, `--force-full-page-ocr`, `--ocr-engine`, `--max-pages`, `--page-range`, `--pdf-backend`. Failures: conversion errors bubble via Docling status; status checked later. Perf: CPU/GPU heavy; optional OCR external calls.
5) **Auto-OCR decision** — For `ocr_mode=auto`, compute chars/page and spaced table ratio, rerun with OCR when sparse/spacing issues, and compare metrics in [convert_pdf_to_doc](src/pdf_to_markdown_docling/conversion_utils.py#L334-L378) using [audit_doc_vs_markdown](src/pdf_to_markdown_docling/audit_utils.py#L272-L334). Inputs: initial Docling doc. Outputs: possibly OCR-backed doc. Flags: `--ocr-mode`, `--force-full-page-ocr`. Perf: potential second full conversion + OCR.
6) **Spacing-page detection** — Identify pages needing spacing repair via [detect_spacing_pages](src/pdf_to_markdown_docling/conversion_utils.py#L400-L419) with predicates [needs_spacing_fix](src/pdf_to_markdown_docling/audit_utils.py#L150-L154) and [needs_table_spacing_fix](src/pdf_to_markdown_docling/audit_utils.py#L155-L168). Inputs: Docling doc. Outputs: page set or None. Flags: `--spacing-fix`. Perf: doc traversal only.
7) **Spacing repair** — Apply chosen strategy based on `--spacing-fix`/`--fix-spaced-tables`: Docling word/char cells via [fix_spaced_items_with_word_cells](src/pdf_to_markdown_docling/spacing_fix.py#L221-L305), PyMuPDF glyphs via [fix_spaced_items_with_pymupdf_glyphs](src/pdf_to_markdown_docling/pymupdf_spacing_fix.py#L365-L509), or OCR-table merge via [merge_spaced_table_cells](src/pdf_to_markdown_docling/table_fixes.py#L785-L855) as orchestrated in [convert_pdf_to_doc](src/pdf_to_markdown_docling/conversion_utils.py#L378-L457). Inputs: Docling doc (+ optional OCR doc). Outputs: repaired doc. Flags: `--spacing-fix`, `--fix-spaced-tables`. Failures: gracefully skip when pages unknown; prints stats if not quiet. Perf: PyMuPDF path reads PDF pages (I/O/CPU); OCR path triggers extra conversion.
8) **Numeric/table OCR repair** — Count suspect currency cells and merge higher-quality OCR text when needed in [convert_pdf_to_doc](src/pdf_to_markdown_docling/conversion_utils.py#L457-L485) using [count_suspect_table_cells](src/pdf_to_markdown_docling/table_fixes.py#L681-L694) and [merge_suspect_table_cells](src/pdf_to_markdown_docling/table_fixes.py#L695-L784). Inputs: Docling doc (+ OCR doc). Outputs: repaired tables. Flags: implicit, triggered only if suspects>0. Perf: possible extra OCR conversion.
9) **Table/header cleanup** — Collapse header column groups, normalize headers, clean cell text, and align currencies in [collapse_document_table_groups](src/pdf_to_markdown_docling/table_fixes.py#L415-L456), [normalize_document_table_headers](src/pdf_to_markdown_docling/table_fixes.py#L599-L607), [clean_document_table_cells](src/pdf_to_markdown_docling/table_fixes.py#L608-L671), and [normalize_document_table_currencies](src/pdf_to_markdown_docling/table_fixes.py#L672-L680), invoked from [convert_pdf_to_doc](src/pdf_to_markdown_docling/conversion_utils.py#L485-L506). Inputs: Docling doc. Outputs: normalized tables. Perf: doc traversal only.
10) **Image-region cleanup & KPI captions** — Remove date-only or axis-like text inside pictures in [remove_date_only_text_inside_pictures](src/pdf_to_markdown_docling/date_cleanup.py#L73-L126) and [remove_axis_text_inside_pictures](src/pdf_to_markdown_docling/date_cleanup.py#L129-L189); optionally OCR KPI-like text from pictures when env `KPI_OCR` permits in [add_picture_kpi_captions](src/pdf_to_markdown_docling/picture_kpi_extract.py#L196-L279). Triggered in [convert_pdf_to_doc](src/pdf_to_markdown_docling/conversion_utils.py#L485-L506). Inputs: Docling doc + PDF path. Outputs: cleaned picture regions and added captions. Flags: env `KPI_OCR` (default on via [_kpi_ocr_enabled](src/pdf_to_markdown_docling/conversion_utils.py#L73-L118)). Perf: picture OCR uses PyMuPDF + optional tesseract (I/O/CPU).
11) **Whitespace normalization** — Collapse extra spaces and normalize ligatures on non-table text via [normalize_document_text_whitespace](src/pdf_to_markdown_docling/whitespace_fix.py#L7-L46) invoked in [convert_pdf_to_doc](src/pdf_to_markdown_docling/conversion_utils.py#L485-L506). Perf: doc traversal only.
12) **Markdown export & noise reduction** — Save Markdown with page markers then clean noise, KPI blocks, orphan headings, and axis-like lines in [convert_pdf_to_markdown](src/pdf_to_markdown_docling/conversion_utils.py#L231-L288) using [add_visible_page_markers](src/pdf_to_markdown_docling/export_utils.py#L44-L63), [reduce_markdown_noise](src/pdf_to_markdown_docling/export_utils.py#L88-L222), [normalize_kpi_blocks](src/pdf_to_markdown_docling/export_utils.py#L223-L281), [remove_axis_like_lines](src/pdf_to_markdown_docling/export_utils.py#L282-L321), and [remove_orphan_headings](src/pdf_to_markdown_docling/export_utils.py#L322-L355). Inputs: Docling doc, output path. Outputs: final Markdown file (and images if referenced mode). Perf: file write + string processing.
13) **Quality/audit (optional)** — CLI `--audit` computes fidelity metrics against Markdown in [audit_doc_vs_markdown](src/pdf_to_markdown_docling/audit_utils.py#L272-L334) and per-page stats in [audit_doc_vs_markdown_per_page](src/pdf_to_markdown_docling/audit_utils.py#L346-L382), invoked from [src/pdf_to_markdown_docling/cli.py#L244-L271](src/pdf_to_markdown_docling/cli.py#L244-L271). Failures: none, prints stats. Perf: doc traversal + text tokenization.

## Example flows
- **A) Docling path (default)** — Conditions: `--pdf-backend auto`, `--ocr-mode off` (unless `--ocr` flips to on), `--spacing-fix pymupdf` default. Stages executed: 1→2→3 (auto probe)→4 (non-OCR conversion)→5 (auto-OCR skipped because off)→6→7 (PyMuPDF spacing fix)→8 (only if suspects)→9→10 (KPI captions gated by `KPI_OCR`)→11→12; optional 13 if `--audit`. Key branches: backend chosen via [select_backend_auto](src/pdf_to_markdown_docling/conversion_utils.py#L205-L229); spacing repair uses PyMuPDF glyphs in [fix_spaced_items_with_pymupdf_glyphs](src/pdf_to_markdown_docling/pymupdf_spacing_fix.py#L365-L509) because `spacing_fix` resolves to `pymupdf` in [src/pdf_to_markdown_docling/cli.py#L214-L218](src/pdf_to_markdown_docling/cli.py#L214-L218).
- **B) PyMuPDF spacing + OCR tables (spacing_fix=ocr)** — Conditions: `--spacing-fix ocr` or `--fix-spaced-tables` with `--spacing-fix off` (mapped to `ocr`) in [src/pdf_to_markdown_docling/cli.py#L214-L218](src/pdf_to_markdown_docling/cli.py#L214-L218). Stages: 1→2→3→4 (initial conversion per `ocr_mode`)→5 (auto-OCR may rerun)→6→7 (OCR table merge via [merge_spaced_table_cells](src/pdf_to_markdown_docling/table_fixes.py#L785-L855) plus PyMuPDF spacing if still enabled)→8→9→10→11→12; optional 13. Branching: OCR table doc created inside [convert_pdf_to_doc](src/pdf_to_markdown_docling/conversion_utils.py#L378-L457) and merged when spaced ratio exceeds threshold.

See [docs/FEATURE_MATRIX.md](FEATURE_MATRIX.md) for option-by-option effects and [docs/DIAGRAMS.md](DIAGRAMS.md) for visuals.
